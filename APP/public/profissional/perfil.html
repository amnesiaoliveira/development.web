<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meu Perfil • Profissional</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <style>
    body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
    .card { border-radius: 20px; }
    .foto-perfil { width: 150px; height: 150px; object-fit: cover; }
  </style>
</head>
<body class="text-white">
  <div class="container py-5">
    <div class="card shadow-lg bg-white text-dark">
      <div class="card-body p-5">
        <div class="text-center mb-4">
          <img src="/img/avatar-default.png" id="fotoPreview" class="rounded-circle foto-perfil border border-5 border-white shadow">
          <h3 class="mt-3" id="nomeUsuario">Carregando...</h3>
          <span class="badge bg-success fs-5">Profissional</span>
        </div>

        <form id="formPerfil">
          <div class="mb-3">
            <label class="form-label fw-bold">Foto de perfil</label>
            <input type="file" class="form-control" accept="image/*" name="foto_perfil">
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">Bio / Apresentação</label>
            <textarea class="form-control" rows="3" name="bio" placeholder="Fala um pouco sobre você..."></textarea>
          </div>

          <div class="mb-4">
            <label class="form-label fw-bold">Raio de atuação</label>
            <input type="range" class="form-range" min="5" max="100" value="20" name="raio_atuacao_km">
            <div class="text-center mt-2"><span id="raioValor" class="fs-4">20 km</span></div>
          </div>

          <div class="mb-4">
            <label class="form-label fw-bold">Categorias que atendo</label>
            <div id="categoriasContainer" class="row g-2"></div>
          </div>

          <button type="submit" class="btn btn-primary btn-lg w-100">
            <i class="bi bi-check-circle"></i> Salvar Perfil
          </button>
        </form>
      </div>
    </div>
  </div>

  <script>
    const token = localStorage.getItem('token');
    if (!token) location.href = '/login.html';
    const payload = JSON.parse(atob(token.split('.')[1]));
    document.getElementById('nomeUsuario').textContent = payload.nome;

    // Carregar dados do perfil
    fetch('/api/perfil', { headers: { Authorization: 'Bearer ' + token } })
      .then(r => r.json())
      .then(data => {
        if (data.bio) document.querySelector('[name="bio"]').value = data.bio;
        if (data.raio_atuacao_km) {
          document.querySelector('[name="raio_atuacao_km"]').value = data.raio_atuacao_km;
          document.getElementById('raioValor').textContent = data.raio_atuacao_km + ' km';
        }
        if (data.foto_perfil) document.getElementById('fotoPreview').src = data.foto_perfil;
        if (data.categorias) {
          const cats = JSON.parse(data.categorias);
          document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = cats.includes(cb.value));
        }
      });

    // Atualizar valor do raio
    document.querySelector('[name="raio_atuacao_km"]').oninput = e => {
      document.getElementById('raioValor').textContent = e.target.value + ' km';
    };

    // Categorias
    fetch('/api/categorias').then(r => r.json()).then(cats => {
      const container = document.getElementById('categoriasContainer');
      cats.forEach(c => {
        container.innerHTML += `
          <div class="col-6 col-md-4">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="${c.nome}" id="cat${c.id}">
              <label class="form-check-label" for="cat${c.id}">${c.nome}</label>
            </div>
          </div>`;
      });
    });

    // Salvar
    document.getElementById('formPerfil').onsubmit = async e => {
      e.preventDefault();
      const formData = new FormData(e.target);

      const categoriasSelecionadas = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
        .map(cb => cb.value);

      // Substitui ou adiciona o campo categorias como JSON válido
      formData.set('categorias', JSON.stringify(categoriasSelecionadas));

      const res = await fetch('/api/perfil', {
        method: 'POST',
        headers: { Authorization: 'Bearer ' + token },
        body: formData
      });

      const json = await res.json();
      if (res.ok) {
        alert('Perfil salvo com sucesso!');
        location.reload();
      } else {
        alert(json.mensagem || 'Erro ao salvar');
      }
    };
  </script>
</body>
</html>